<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì¹´ì¹´ì˜¤ ì§€ë„ì™€ ë‚´ë¹„ ì—°ë™</title>
    <style>
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #status {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            z-index: 1;
        }
    </style>
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5aefe0539358793ca2935a52f01e03db&libraries=services"></script>
</head>
<body>
    <div id="status">ê²½ë¡œë¥¼ ì°¾ëŠ” ì¤‘...</div>
    <div id="map"></div>

    <script>
        var map = new kakao.maps.Map(document.getElementById('map'), {
            center: new kakao.maps.LatLng(37.5665, 126.9780),
            level: 3
        });

        var currentMarker = null;
        var currentAccuracyCircle = null;
        var destinationMarker = null;
        var routePolyline = null;
        var passedPolyline = new kakao.maps.Polyline({
            path: [],
            strokeWeight: 5,
            strokeColor: '#00FF00',
            strokeOpacity: 0.8,
            strokeStyle: 'solid',
            map: map
        });
        var destinationLatLng = null;
        var waypoints = [];
        var waypointMarkers = [];
        var currentWaypointIndex = 0;
        var geocoder = new kakao.maps.services.Geocoder();
        var ws = null;
        var waypointsWs = null;

        function updateLocation(lat, lon) {
            if (!lat || !lon) return;
            var locPosition = new kakao.maps.LatLng(lat, lon);
            console.log(" í˜„ì¬ ìœ„ì¹˜ ì—…ë°ì´íŠ¸:", lat, lon);

            if (currentMarker) {
                currentMarker.setPosition(locPosition);
            } else {
                currentMarker = new kakao.maps.Marker({
                    position: locPosition,
                    map: map,
                    title: "í˜„ì¬ ìœ„ì¹˜"
                });
            }

            if (currentAccuracyCircle) {
                currentAccuracyCircle.setPosition(locPosition);
            } else {
                currentAccuracyCircle = new kakao.maps.Circle({
                    center: locPosition,
                    radius: 50,
                    strokeWeight: 2,
                    strokeColor: '#00A0E9',
                    strokeOpacity: 0.8,
                    strokeStyle: 'solid',
                    fillColor: '#00A0E9',
                    fillOpacity: 0.3,
                    map: map
                });
            }

            map.setCenter(locPosition);
            checkWaypointPass(lat, lon);
            
        }
        function getRouteData(startPos, endPos) {
            var url = 'https://apis-navi.kakaomobility.com/v1/directions';
            url += '?origin=' + startPos.getLng() + ',' + startPos.getLat();
            url += '&destination=' + endPos.getLng() + ',' + endPos.getLat();

            fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': 'KakaoAK 0a115b0069642fd0547386e225798817'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log("ğŸ“¡ ê²½ë¡œ ë°ì´í„° ìˆ˜ì‹ :", data);
                if (!data.routes || data.routes.length === 0) {
                    console.error("âŒ ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    document.getElementById("status").innerText = "ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                    return;
                }

                waypoints = [];
                currentWaypointIndex = 0;
                passedPolyline.setPath([]);

                data.routes[0].sections[0].roads.forEach(function(road) {
                    road.vertexes.forEach((coord, index) => {
                        if (index % 2 === 0) {
                            var lat = road.vertexes[index + 1];
                            var lng = coord;
                            waypoints.push(new kakao.maps.LatLng(lat, lng));
                        }
                    });
                });

                drawRoute(waypoints);
                drawWaypointMarkers(waypoints);

                console.log("ğŸ—ºï¸ ì›¨ì´í¬ì¸íŠ¸ ê°œìˆ˜:", waypoints.length);
                waypoints.forEach(wp => console.log(wp.getLat(), wp.getLng()));

                document.getElementById("status").innerText = "âœ… ê²½ë¡œ ì°¾ê¸° ì™„ë£Œ! í˜„ì¬ ìœ„ì¹˜ì—ì„œ ì¶œë°œí•´ì£¼ì„¸ìš”.";

                // âœ… Waypoints ë°ì´í„° ì „ì†¡ (ë°ì´í„° ìˆ˜ì‹  ì´í›„ì— ì‹¤í–‰ ë³´ì¥)
                sendWaypointsToROS();
            })
            .catch(error => {
                console.error("âŒ ê²½ë¡œ ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨:", error);
                document.getElementById("status").innerText = "ê²½ë¡œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            });
        }

        // âœ… ROSë¡œ Waypoints ì „ì†¡ í•¨ìˆ˜
        function sendWaypointsToROS() {
            if (waypoints.length === 0) {
                console.error("âŒ ì „ì†¡í•  Waypoints ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // ëª©ì ì§€ ì¢Œí‘œ ì¶”ê°€
            var destinationData = destinationLatLng
                ? { lat: destinationLatLng.getLat(), lon: destinationLatLng.getLng() }
                : null;

            var waypointsData = {
                waypoints: waypoints.map(wp => ({ lat: wp.getLat(), lon: wp.getLng() })),
                destination: destinationData // âœ… ëª©ì ì§€ ì¢Œí‘œ ì¶”ê°€
            };

            if (waypointsWs && waypointsWs.readyState === WebSocket.OPEN) {
                waypointsWs.send(JSON.stringify(waypointsData));
                console.log("ğŸ“¡ Waypoints & ëª©ì ì§€ ë°ì´í„° ì „ì†¡ë¨:", waypointsData);
                document.getElementById("status").innerText = "ğŸ“¡ Waypoints & ëª©ì ì§€ ì „ì†¡ ì™„ë£Œ!";
            } else {
                console.error("âŒ Waypoints WebSocketì´ ë‹«í˜€ ìˆìŠµë‹ˆë‹¤.");
            }
        }

        function drawRoute(coords) {
            if (routePolyline) routePolyline.setMap(null);
            routePolyline = new kakao.maps.Polyline({
                path: coords,
                strokeWeight: 5,
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeStyle: 'solid',
                map: map
            });
        }

        function drawWaypointMarkers(coords) {
            waypointMarkers.forEach(function(marker) {
                marker.setMap(null);
            });
            waypointMarkers = [];

            coords.forEach(function(coord) {
                var marker = new kakao.maps.Marker({
                    position: coord,
                    map: map,
                    title: "ì›¨ì´í¬ì¸íŠ¸",
                    image: new kakao.maps.MarkerImage(
                        "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png",
                        new kakao.maps.Size(24, 35)
                    )
                });
                waypointMarkers.push(marker);
            });
        }

        function checkWaypointPass(lat, lon) {
            if (waypoints.length === 0 || currentWaypointIndex >= waypoints.length) return;

            let waypoint = waypoints[currentWaypointIndex];
            let distance = haversineDistance(lat, lon, waypoint.getLat(), waypoint.getLng());

            if (distance < 5) {
                console.log("ğŸŸ¢ ì›¨ì´í¬ì¸íŠ¸ í†µê³¼:", currentWaypointIndex);

                waypointMarkers[currentWaypointIndex].setMap(null);

                if (currentWaypointIndex > 0) {
                    passedPolyline.setPath([...passedPolyline.getPath(), waypoints[currentWaypointIndex]]);
                } else {
                    passedPolyline.setPath([waypoints[currentWaypointIndex]]);
                }

                currentWaypointIndex++;

                let progress = Math.floor((currentWaypointIndex / waypoints.length) * 100);
                if (progress > 100) progress = 100;

                if (currentWaypointIndex >= waypoints.length) {
                    document.getElementById("status").innerText = "ëª©ì ì§€ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤!";
                } else {
                    // âœ… í…œí”Œë¦¿ ë¦¬í„°ëŸ´(``` ` ```) ì‚¬ìš©í•˜ì—¬ ì˜¬ë°”ë¥´ê²Œ ìˆ˜ì •
                    document.getElementById("status").innerText = `ì§„í–‰ë¥ : ${progress}%`;
                }

                console.log("ì§„í–‰ë¥ :", progress, "%");
            }
}
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const toRad = degree => degree * Math.PI / 180;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R

            * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
            var clickedPosition = mouseEvent.latLng;

            if (destinationMarker) {
                destinationMarker.setPosition(clickedPosition);
            } else {
                destinationMarker = new kakao.maps.Marker({
                    position: clickedPosition,
                    map: map,
                    title: "ëª©ì ì§€"
                });
            }

            destinationLatLng = clickedPosition;
            console.log(" ëª©ì ì§€ ì„ íƒ:", clickedPosition.getLat(), clickedPosition.getLng());

            document.getElementById("status").innerText = "í´ë¦­í•œ ìœ„ì¹˜ë¡œ ê²½ë¡œ ê³„ì‚° ì¤‘...";

            if (currentMarker) {
                getRouteData(currentMarker.getPosition(), destinationLatLng);
            } else {
                alert("í˜„ì¬ ìœ„ì¹˜ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. GPSë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
                document.getElementById("status").innerText = "í˜„ì¬ ìœ„ì¹˜ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            }
        });

        function connectWebSocket() {
            ws = new WebSocket("ws://localhost:8765");

            ws.onopen = function () {
                console.log("âœ… GPS WebSocket ì—°ê²° ì„±ê³µ!");
                document.getElementById("status").innerText = "GPS ì—°ê²°ë¨. ëª©ì ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.";
                connectWaypointsWebSocket(); // âœ… GPS ì—°ê²° í›„ Waypoints WebSocket ì‹¤í–‰ ë³´ì¥
            };

            ws.onmessage = function (event) {
                try {
                    var data = JSON.parse(event.data);
                    if (data.latitude && data.longitude) {
                        updateLocation(data.latitude, data.longitude);
                    } else {
                        console.warn("âš ï¸ GPS ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤:", data);
                    }
                } catch (error) {
                    console.error("âŒ GPS ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:", error);
                }
            };

            ws.onerror = function (error) {
                console.error("âŒ GPS WebSocket ì˜¤ë¥˜:", error);
                document.getElementById("status").innerText = "GPS ì—°ê²° ì˜¤ë¥˜";
            };

            ws.onclose = function () {
                console.warn("âš ï¸ GPS WebSocket ì—°ê²° ì¢…ë£Œë¨. 5ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„...");
                document.getElementById("status").innerText = "GPS ì—°ê²° ëŠê¹€. ì¬ì—°ê²° ì¤‘...";
                setTimeout(connectWebSocket, 5000);
            };
        }

        function connectWaypointsWebSocket() {
            if (waypointsWs && (waypointsWs.readyState === WebSocket.OPEN || waypointsWs.readyState === WebSocket.CONNECTING)) {
                console.log("âš ï¸ Waypoints WebSocket ì´ë¯¸ ì—°ê²°ë¨.");
                return; // âœ… ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´ ì¬ì—°ê²° ì‹œë„í•˜ì§€ ì•ŠìŒ
            }

            waypointsWs = new WebSocket("ws://localhost:8766");

            waypointsWs.onopen = function () {
                console.log("âœ… Waypoints WebSocket ì—°ê²° ì„±ê³µ!");
            };

            waypointsWs.onerror = function (error) {
                console.error("âŒ Waypoints WebSocket ì˜¤ë¥˜:", error);
            };

            waypointsWs.onclose = function () {
                console.warn("âš ï¸ Waypoints WebSocket ì—°ê²° ì¢…ë£Œë¨. 5ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„...");
                setTimeout(connectWaypointsWebSocket, 5000);
            };
        }

        // âœ… WebSocket ìµœì´ˆ ì‹¤í–‰ (í•œ ë²ˆë§Œ)
        connectWebSocket();


    </script>
</body>
</html>