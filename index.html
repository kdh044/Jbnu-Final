<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì¹´ì¹´ì˜¤ ì§€ë„ì™€ ë‚´ë¹„ ì—°ë™</title>
  <style>
    /* ì§€ë„ ì˜ì—­ ìŠ¤íƒ€ì¼ */
    #map {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    #status {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 16px;
      font-weight: bold;
      z-index: 1;
    }
    .controls {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 1;
      width: 300px;
      text-align: center;
    }
    input {
      width: 70%;
      padding: 8px;
      margin-right: 5px;
    }
    button {
      padding: 8px 15px;
    }
  </style>
  <!-- ì¹´ì¹´ì˜¤ ì§€ë„ API ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5aefe0539358793ca2935a52f01e03db&libraries=services"></script>
</head>
<body>
  <div id="status">ê²½ë¡œë¥¼ ì°¾ëŠ” ì¤‘...</div>
  <div class="controls">
    <h2>ì‹¤ì‹œê°„ ìœ„ì¹˜ ì¶”ì  ë° ê²½ë¡œ ì•ˆë‚´</h2>
    <input type="text" id="destinationInput" placeholder="ëª©ì ì§€ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
    <button onclick="searchDestination()">ê²½ë¡œ ì°¾ê¸°</button>
  </div>
  <div id="map"></div>

  <script>
    // ì§€ë„ ìƒì„± ë° ë³€ìˆ˜ ì„ ì–¸
    var map = new kakao.maps.Map(document.getElementById('map'), {
      center: new kakao.maps.LatLng(37.5665, 126.9780),
      level: 3
    });
    
    // ì£¼ìš” ë³€ìˆ˜ ì„ ì–¸
    var currentMarker = null;
    var currentAccuracyCircle = null; // í˜„ì¬ ìœ„ì¹˜ ì •í™•ë„ ì›
    var destinationMarker = null;
    var routePolyline = null;
    var passedPolyline = new kakao.maps.Polyline({ 
      path: [], 
      strokeWeight: 5, 
      strokeColor: '#00FF00', 
      strokeOpacity: 0.8, 
      strokeStyle: 'solid', 
      map: map 
    });
    var destinationLatLng = null;
    var waypoints = []; // ê²½ë¡œ ì›¨ì´í¬ì¸íŠ¸
    var waypointMarkers = []; // ì›¨ì´í¬ì¸íŠ¸ ë§ˆì»¤
    var currentWaypointIndex = 0; // í˜„ì¬ í†µê³¼í•œ ì›¨ì´í¬ì¸íŠ¸ ì¸ë±ìŠ¤
    var geocoder = new kakao.maps.services.Geocoder();
    var ws = null;

    // í˜„ì¬ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateLocation(lat, lon) {
      if (!lat || !lon) return;
      var locPosition = new kakao.maps.LatLng(lat, lon);
      console.log("ğŸ“ í˜„ì¬ ìœ„ì¹˜ ì—…ë°ì´íŠ¸:", lat, lon);
      
      // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸
      if (currentMarker) {
        currentMarker.setPosition(locPosition);
      } else {
        currentMarker = new kakao.maps.Marker({
          position: locPosition,
          map: map,
          title: "í˜„ì¬ ìœ„ì¹˜"
        });
      }
      
      // í˜„ì¬ ìœ„ì¹˜ ì •í™•ë„ ì›
      if (currentAccuracyCircle) {
        currentAccuracyCircle.setPosition(locPosition);
      } else {
        currentAccuracyCircle = new kakao.maps.Circle({
          center: locPosition,
          radius: 50,
          strokeWeight: 2,
          strokeColor: '#00A0E9',
          strokeOpacity: 0.8,
          strokeStyle: 'solid',
          fillColor: '#00A0E9',
          fillOpacity: 0.3,
          map: map
        });
      }
      
      map.setCenter(locPosition);
      
      // ì›¨ì´í¬ì¸íŠ¸ í†µê³¼ í™•ì¸
      checkWaypointPass(lat, lon);
    }

    // ì¹´ì¹´ì˜¤ë‚´ë¹„ APIë¡œ ê²½ë¡œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
    function getRouteData(startPos, endPos) {
      var url = 'https://apis-navi.kakaomobility.com/v1/directions';
      url += '?origin=' + startPos.getLng() + ',' + startPos.getLat();
      url += '&destination=' + endPos.getLng() + ',' + endPos.getLat();
      
      fetch(url, {
        method: 'GET',
        headers: {
          'Authorization': 'KakaoAK 0a115b0069642fd0547386e225798817'
        }
      })
      .then(response => response.json())
      .then(data => {
        console.log("ğŸ“ ê²½ë¡œ ë°ì´í„° ìˆ˜ì‹ :", data);
        if (!data.routes || data.routes.length === 0) {
          console.error("âŒ ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          document.getElementById("status").innerText = "ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
          return;
        }
        
        // ì›¨ì´í¬ì¸íŠ¸ ë° ê¸°ì¡´ ê²½ë¡œ ì´ˆê¸°í™”
        waypoints = [];
        currentWaypointIndex = 0;
        passedPolyline.setPath([]);
        
        // ê²½ë¡œ ë°ì´í„° íŒŒì‹±
        data.routes[0].sections[0].roads.forEach(function(road) {
          road.vertexes.forEach((coord, index) => {
            if (index % 2 === 0) {
              var lat = road.vertexes[index + 1];
              var lng = coord;
              waypoints.push(new kakao.maps.LatLng(lat, lng));
            }
          });
        });
        
        drawRoute(waypoints);
        drawWaypointMarkers(waypoints);
        document.getElementById("status").innerText = "ê²½ë¡œ ì°¾ê¸° ì™„ë£Œ! í˜„ì¬ ìœ„ì¹˜ì—ì„œ ì¶œë°œí•´ì£¼ì„¸ìš”.";
      })
      .catch(error => {
        console.error("âŒ ê²½ë¡œ ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨:", error);
        document.getElementById("status").innerText = "ê²½ë¡œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      });
    }

    // í´ë¦¬ë¼ì¸ìœ¼ë¡œ ê²½ë¡œ ê·¸ë¦¬ê¸°
    function drawRoute(coords) {
      if (routePolyline) routePolyline.setMap(null);
      routePolyline = new kakao.maps.Polyline({
        path: coords,
        strokeWeight: 5,
        strokeColor: '#FF0000',
        strokeOpacity: 0.8,
        strokeStyle: 'solid',
        map: map
      });
    }

    // ì›¨ì´í¬ì¸íŠ¸ ë§ˆì»¤ í‘œì‹œ í•¨ìˆ˜
    function drawWaypointMarkers(coords) {
      waypointMarkers.forEach(function(marker) {
        marker.setMap(null);
      });
      waypointMarkers = [];
      
      coords.forEach(function(coord) {
        var marker = new kakao.maps.Marker({
          position: coord,
          map: map,
          title: "ì›¨ì´í¬ì¸íŠ¸",
          image: new kakao.maps.MarkerImage(
            "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png",
            new kakao.maps.Size(24, 35)
          )
        });
        waypointMarkers.push(marker);
      });
    }

    // ëª©ì ì§€ ê²€ìƒ‰ ë° ê²½ë¡œ ìš”ì²­ í•¨ìˆ˜
    function searchDestination() {
      var address = document.getElementById("destinationInput").value;
      if (!address) {
        alert("ëª©ì ì§€ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }
      
      document.getElementById("status").innerText = "ì£¼ì†Œ ê²€ìƒ‰ ì¤‘...";
      
      geocoder.addressSearch(address, function(result, status) {
        if (status === kakao.maps.services.Status.OK) {
          destinationLatLng = new kakao.maps.LatLng(result[0].y, result[0].x);
          
          if (destinationMarker) destinationMarker.setMap(null);
          destinationMarker = new kakao.maps.Marker({
            position: destinationLatLng,
            map: map,
            title: "ëª©ì ì§€"
          });
          
          document.getElementById("status").innerText = "ê²½ë¡œ ê³„ì‚° ì¤‘...";
          
          if (currentMarker) {
            getRouteData(currentMarker.getPosition(), destinationLatLng);
          } else {
            alert("í˜„ì¬ ìœ„ì¹˜ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. GPSë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
            document.getElementById("status").innerText = "í˜„ì¬ ìœ„ì¹˜ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
          }
        } else {
          alert("âŒ ì£¼ì†Œ ë³€í™˜ ì‹¤íŒ¨. ì •í™•í•œ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
          document.getElementById("status").innerText = "ì£¼ì†Œ ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
        }
      });
    }

    // ì›¨ì´í¬ì¸íŠ¸ í†µê³¼ í™•ì¸ í•¨ìˆ˜
    function checkWaypointPass(lat, lon) {
      if (waypoints.length === 0 || currentWaypointIndex >= waypoints.length) return;
      
      let waypoint = waypoints[currentWaypointIndex];
      let distance = haversineDistance(lat, lon, waypoint.getLat(), waypoint.getLng());
      
      // ì›¨ì´í¬ì¸íŠ¸ 5m ë°˜ê²½ ë‚´ ì§„ì… ì‹œ í†µê³¼ë¡œ ê°„ì£¼
      if (distance < 5) {
        console.log("ğŸŸ¢ ì›¨ì´í¬ì¸íŠ¸ í†µê³¼:", currentWaypointIndex);
        
        // í†µê³¼í•œ ì›¨ì´í¬ì¸íŠ¸ ë§ˆì»¤ ì œê±°
        waypointMarkers[currentWaypointIndex].setMap(null);
        
        // í†µê³¼í•œ ê²½ë¡œ ë…¹ìƒ‰ìœ¼ë¡œ í‘œì‹œ
        if (currentWaypointIndex > 0) {
          passedPolyline.setPath([...passedPolyline.getPath(), waypoints[currentWaypointIndex]]);
        } else {
          passedPolyline.setPath([waypoints[currentWaypointIndex]]);
        }
        
        currentWaypointIndex++;
        
        // ëª¨ë“  ì›¨ì´í¬ì¸íŠ¸ í†µê³¼ ì‹œ
        if (currentWaypointIndex >= waypoints.length) {
          document.getElementById("status").innerText = "ğŸ‰ ëª©ì ì§€ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤!";
        } else {
          document.getElementById("status").innerText = `ì§„í–‰ë¥ : ${Math.floor((currentWaypointIndex / waypoints.length) * 100)}%`;
        }
      }
    }

    // ë‘ ì¢Œí‘œ ê°„ ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (Haversine ê³µì‹)
    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000; // ì§€êµ¬ ë°˜ì§€ë¦„ (ë¯¸í„°)
      const toRad = degree => degree * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + 
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * 
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
      var clickedPosition = mouseEvent.latLng;
      
      if (destinationMarker) {
        destinationMarker.setPosition(clickedPosition);
      } else {
        destinationMarker = new kakao.maps.Marker({
          position: clickedPosition,
          map: map,
          title: "ëª©ì ì§€"
        });
      }
      
      destinationLatLng = clickedPosition;
      console.log("ğŸ“Œ ëª©ì ì§€ ì„ íƒ:", clickedPosition.getLat(), clickedPosition.getLng());
      
      document.getElementById("status").innerText = "í´ë¦­í•œ ìœ„ì¹˜ë¡œ ê²½ë¡œ ê³„ì‚° ì¤‘...";
      
      if (currentMarker) {
        getRouteData(currentMarker.getPosition(), destinationLatLng);
      } else {
        alert("í˜„ì¬ ìœ„ì¹˜ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. GPSë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
        document.getElementById("status").innerText = "í˜„ì¬ ìœ„ì¹˜ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
      }
    });

    // WebSocketì„ í†µí•´ GPS ë°ì´í„° ìˆ˜ì‹ 
    function connectWebSocket() {
      ws = new WebSocket("ws://localhost:8765");
      
      ws.onopen = function () {
        console.log("âœ… WebSocket ì—°ê²° ì„±ê³µ!");
        document.getElementById("status").innerText = "GPS ì—°ê²°ë¨. ëª©ì ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.";
      };
      
      ws.onmessage = function (event) {
        try {
          var data = JSON.parse(event.data);
          if (data.latitude && data.longitude) {
            updateLocation(data.latitude, data.longitude);
          } else {
            console.warn("âš ï¸ GPS ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤:", data);
          }
        } catch (error) {
          console.error("âŒ GPS ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:", error);
        }
      };
      
      ws.onerror = function (error) {
        console.error("âŒ WebSocket ì˜¤ë¥˜:", error);
        document.getElementById("status").innerText = "GPS ì—°ê²° ì˜¤ë¥˜";
      };
      
      ws.onclose = function () {
        console.warn("âš ï¸ WebSocket ì—°ê²° ì¢…ë£Œë¨. 5ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„...");
        document.getElementById("status").innerText = "GPS ì—°ê²° ëŠê¹€. ì¬ì—°ê²° ì¤‘...";
        setTimeout(connectWebSocket, 5000);
      };
    }

    // ì›¹ì†Œì¼“ ì—°ê²° ì‹œì‘
    connectWebSocket();
  </script>
</body>
</html>